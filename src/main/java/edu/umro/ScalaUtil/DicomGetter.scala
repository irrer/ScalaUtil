package edu.umro.ScalaUtil

import com.pixelmed.dicom._
import com.pixelmed.network.ReceivedObjectHandler

import java.io.File

object DicomGetter extends Logging {

  var count = 0

  class DefaultReceivedObjectHandler extends ReceivedObjectHandler {
    override def sendReceivedObjectIndication(fileName: String, transferSyntax: String, callingAETitle: String): Unit = {
      logger.info("Received DICOM from " + callingAETitle + " file " + " DICOM file " + fileName)
      count = count + 1
    }
  }

  def addAttr(tag: AttributeTag, value: String, identifier: AttributeList): AttributeList = {
    val a = AttributeFactory.newAttribute(tag)
    a.addValue(value)
    identifier.put(a)
    identifier
  }

  def buildIdentifier: AttributeList = {
    addAttr(TagFromName.QueryRetrieveLevel, "SERIES", new AttributeList)
  }

  def main(args: Array[String]): Unit = {

    //val mainDirName = """D:\tmp\aqa\tmp\May9_TX4"""
    val mainDirName = """D:\tmp\aqa\tmp\Jul_Missing"""

    val mainDir = new File(mainDirName)
    println("Putting files in: " + mainDir.getAbsolutePath)
    mainDir.mkdirs

    val cpXstorPacs = new PACS("CP_XSTOR_IRRER", "141.214.125.209", 15656)
    val irrerPacs = new PACS("IRRER", "141.214.125.209", 15678)
    val umroarchivePacs = new PACS("UMRO_ARCHIVE", "10.30.3.69", 104)
    val evalPacs = new PACS("EVAL1109", "141.214.124.189", 104)
    val wlqaTestPacs = new PACS("WLQA_TEST", "141.214.125.209", 5682)
    val clinPacs = new PACS("VMSDBD", "10.30.65.100", 105)
    val clinPacsX  = new PACS("VMSDBD", "10.30.65.100", 1433)

    val thisPacs = wlqaTestPacs
    val thatPacs = clinPacs

    println("localPacs: " + thisPacs)
    println("remotePacs: " + thatPacs)

    val dicomReceiver = new DicomReceiver(mainDir, thisPacs)

    val seriesUidSeqMay9_TX4 = Seq(
      "1.2.246.352.61.2.4736248975032438764.17557397290654793385",
      "1.2.246.352.61.2.5078458363670471109.14810913391405883560",
      "1.2.246.352.61.2.5187461766680823991.2305822249509511303",
      "1.2.246.352.61.2.5115451825195345706.6473994088005628320",
      "1.2.246.352.61.2.5597865179667758918.18425015796824976538",
      "1.2.246.352.61.2.4697786685783655844.1333282640741256100",
      "1.2.246.352.61.2.4738999668362136179.13733235375557839014",
      "1.2.246.352.61.2.4814420317040462539.523298602166789296",
      "1.2.246.352.61.2.4956718520717464437.30611999831760799",
      "1.2.246.352.61.2.5724240852016814383.6403631505273016242",
      "1.2.246.352.61.2.5271855262280508831.2640337907587524485",
      "1.2.246.352.61.2.4805172899480834193.10714707650614063019",
      "1.2.246.352.61.2.4620585291973694107.1871814452784398473",
      "1.2.246.352.61.2.5477890739831696856.15652681217784119958",
      "1.2.246.352.61.2.5369795858714785455.9036689262869321363",
      "1.2.246.352.61.2.5497265680927278532.6465820194084090002",
      "1.2.246.352.61.2.5662283103307752471.1776960486550622894",
      "1.2.246.352.61.2.4717213074312035212.8118886171604444093",
      "1.2.246.352.61.2.5442016808655132257.9599157445072631443",
      "1.2.246.352.61.2.5294417042160336291.17191635105385792694",
      "1.2.246.352.61.2.5362482301937414827.17935519708339404685",
      "1.2.246.352.61.2.5555148993943369796.11639039617076347045",
      "1.2.246.352.61.2.5709758603574596911.11773304505112628904",
      "1.2.246.352.61.2.5335637450956978670.6078697464922007692",
      "1.2.246.352.71.2.824327626427.4630938.20190821162314")

    val seriesUidSeqPR = Seq(
      "1.2.246.352.61.2.5178694219898672721.389378833256730018",
      "1.2.246.352.61.2.5161223215598234460.14557423482060322691",
      "1.2.246.352.61.2.4653487441837705367.7941613449241115832",
      "1.2.246.352.61.2.5306251543407980150.16776754834691654532",
      "1.2.246.352.61.2.5225822004263547719.801547019551562382",
      "1.2.246.352.61.2.4948001943159681635.4023803078726985918",
      "1.2.246.352.61.2.5439582124918186049.14459379367775809427",
      "1.2.246.352.61.2.5288679518931713833.2980130239326461596",
      "1.2.246.352.61.2.5617732172644135967.2397603148742365589",
      "1.2.246.352.61.2.4939014221484870786.16715912921333004964",
      "1.2.246.352.61.2.5754768356153461458.9826898794328188861",
      "1.2.246.352.61.2.5139853001949774239.3566939144251984560",
      "1.2.246.352.61.2.5199332294280250251.8283688663824585656",
      "1.2.246.352.61.2.4947112726672536998.2327180857946594188",
      "1.2.246.352.61.2.5136191120555480928.287821785834275727",
      "1.2.246.352.61.2.5741855221842333841.17012404323283973308",
      "1.2.246.352.61.2.5516466383715642168.4910801812511935926",
      "1.2.246.352.61.2.4626029298599537411.8225813755205460615",
      "1.2.246.352.61.2.5740470007493782784.11961110870271311780",
    )

    val seriesTX2_RTIMAGE = Seq("1.2.246.352.61.2.5114746999821828655.11474646231719155335")


    val seriesUidSeq = Seq(
      "1.2.246.352.61.2.5181765138530440586.10271888173485686166",
      "1.2.246.352.61.2.4943033272339337398.1659082882001272238",
      "1.2.246.352.61.2.5178694219898672721.389378833256730018",
      "1.2.246.352.61.2.5124533148547240400.10197946192284687263",
      "1.2.246.352.61.2.5161223215598234460.14557423482060322691",
      "1.2.246.352.61.2.4653487441837705367.7941613449241115832",
      "1.2.246.352.61.2.4643347551104958424.1353062599432636582",
      "1.2.246.352.61.2.4660210429243865950.5546376927965327499",
      "1.2.246.352.61.2.5306251543407980150.16776754834691654532",
      "1.2.246.352.61.2.5718891796375417464.10803163514933895849",
      "1.2.246.352.61.2.4815850732453090434.1637164180659084721",
      "1.2.246.352.61.2.5225822004263547719.801547019551562382",
      "1.2.246.352.61.2.5279347360091531969.7115491817367959686",
      "1.2.246.352.61.2.5423053162407673463.8991095648278085042",
      "1.2.246.352.61.2.4948001943159681635.4023803078726985918",
      "1.2.246.352.61.2.4804194240519300604.5443671400093588644",
      "1.2.246.352.61.2.5153877822380056108.11060432208422936737",
      "1.2.246.352.61.2.5439582124918186049.14459379367775809427",
      "1.2.246.352.61.2.4738933490198914683.16090414578903492742",
      "1.2.246.352.61.2.5285450244887598440.4929096113508608146",
      "1.2.246.352.61.2.5288679518931713833.2980130239326461596",
      "1.2.246.352.61.2.5695246932955620854.17093508572032096654",
      "1.2.246.352.61.2.5548319543812070486.17930946680038037",
      "1.2.246.352.61.2.5617732172644135967.2397603148742365589",
      "1.2.246.352.61.2.4939014221484870786.16715912921333004964",
      "1.2.246.352.61.2.4659217659452840164.5470617049065146761",
      "1.2.246.352.61.2.4934336992954711563.16459648056479586187",
      "1.2.246.352.61.2.5754768356153461458.9826898794328188861",
      "1.2.246.352.61.2.5280563105413626303.8147310505106412469",
      "1.2.246.352.61.2.4700961591250910357.330032137145478568",
      "1.2.246.352.61.2.5139853001949774239.3566939144251984560",
      "1.2.246.352.61.2.4748185842420872784.10514091660948107671",
      "1.2.246.352.61.2.4894820063754357853.7410460124305055924",
      "1.2.246.352.61.2.5199332294280250251.8283688663824585656",
      "1.2.246.352.61.2.4920072452277515943.17244999499184268969",
      "1.2.246.352.61.2.5295357638985188765.4724565239696584077",
      "1.2.246.352.61.2.4947112726672536998.2327180857946594188",
      "1.2.246.352.61.2.5399513231542576158.5062649622043911601",
      "1.2.246.352.61.2.4972401350913605980.4430319199198500242",
      "1.2.246.352.61.2.5136191120555480928.287821785834275727",
      "1.2.246.352.61.2.5327484160266940643.628455366224823942",
      "1.2.246.352.61.2.5429898664930483009.5958727785053694095",
      "1.2.246.352.61.2.5741855221842333841.17012404323283973308",
      "1.2.246.352.61.2.4809413971897806149.12538565008687370930",
      "1.2.246.352.61.2.4890272387710722000.5126668256211034813",
      "1.2.246.352.61.2.5516466383715642168.4910801812511935926",
      "1.2.246.352.61.2.5254158840110933953.2113383503016561033",
      "1.2.246.352.61.2.4997231834254396903.629273788686938778",
      "1.2.246.352.61.2.4626029298599537411.8225813755205460615",
      "1.2.246.352.61.2.5740470007493782784.11961110870271311780",
      "1.2.246.352.61.2.4977925924602888284.12852090326955177375",
      "1.2.246.352.61.2.5128047862095082249.17192107392648001977"
    )

    val sopRtplanList = Seq(
      "1.2.246.352.71.5.427549902257.668332.20190825122736",
      "1.2.246.352.71.5.427549902257.685632.20191030112620",
      "1.2.246.352.71.5.427549902257.690058.20191115101945",
      "1.2.246.352.71.5.427549902257.690287.20191118080443",
      "1.2.246.352.71.5.427549902257.692177.20191124141309",
      "1.2.246.352.71.5.427549902257.701887.20200109211813",
      "1.2.246.352.71.5.427549902257.703997.20200120160052",
      "1.2.246.352.71.5.427549902257.704527.20200122124151",
      "1.2.246.352.71.5.427549902257.704528.20200122131740",
      "1.2.246.352.71.5.427549902257.704529.20200122134426",
      "1.2.246.352.71.5.427549902257.704530.20200122135330",
      "1.2.246.352.71.5.427549902257.710157.20200213091126",
      "1.2.246.352.71.5.427549902257.712623.20200224111632",
      "1.2.246.352.71.5.427549902257.719832.20200327062540",
      "1.2.246.352.71.5.427549902257.728422.20200506103412",
      "1.2.246.352.71.5.427549902257.733182.20200529113045",
      "1.2.246.352.71.5.427549902257.733412.20200529211323",
      "1.2.246.352.71.5.427549902257.733413.20200529214302",
      "1.2.246.352.71.5.427549902257.733414.20200529220856",
      "1.2.246.352.71.5.427549902257.733415.20200529222638",
      "1.2.246.352.71.5.427549902257.733416.20200529224347",
      "1.2.246.352.71.5.427549902257.734832.20200604164524",
      "1.2.246.352.71.5.427549902257.739792.20200629093357",
      "1.2.246.352.71.5.427549902257.743777.20200720081400",
      "1.2.246.352.71.5.824327626427.666663.20190821154741",
      "1.2.246.352.71.5.824327626427.666664.20190821161303",
      "1.2.246.352.71.5.824327626427.666665.20190821163000",
      "1.2.246.352.71.5.824327626427.666667.20190821171713",
      "1.2.246.352.71.5.824327626427.666668.20190821173500",

    )

    val regSeriesList = Seq(
      "1.2.246.352.62.2.5385458967907575494.14970525155448755881",
      "1.2.246.352.62.2.5093578298808109697.10484140957319377313",
      "1.2.246.352.62.2.5588255649974877880.17185394798501075369",
      "1.2.246.352.62.2.5035987562270830048.7663403885682032265",
      "1.2.246.352.62.2.4848973319993640698.6372312420172789166",
      "1.2.246.352.62.2.5405544414834140737.10435320682879197579",
      "1.2.246.352.62.2.5349246692312153212.6937559147488128662",
      "1.2.246.352.62.2.4648412184809110821.899346862499492009",
      "1.2.246.352.62.2.5229480817028366757.4498713650385996467",
    )


    val July21 = Seq(
      "1.2.246.352.62.2.4876217766146919743.159007202772479673",
      "1.2.246.352.62.2.5385458967907575494.14970525155448755881",
      "1.2.246.352.62.2.5130440997397930287.17846795184274493335",
      "1.2.246.352.62.2.5093578298808109697.10484140957319377313",
      "1.2.246.352.62.2.5672876062310897656.766975969336826017",
      "1.2.246.352.62.2.5588255649974877880.17185394798501075369",
      "1.2.246.352.62.2.5612485553806952309.4424528925093566102",
      "1.2.246.352.62.2.5623241090892547613.3078824027762914691",
      "1.2.246.352.62.2.5331381008654776753.8958121464933135537",
      "1.2.246.352.62.2.5035987562270830048.7663403885682032265",
      "1.2.246.352.62.2.5238697069669846627.5860194943353013928",
      "1.2.246.352.62.2.5249249798598908278.18152603404250394544",
      "1.2.246.352.62.2.5131358401985915084.4666402461219085746",
      "1.2.246.352.62.2.4848973319993640698.6372312420172789166",
      "1.2.246.352.62.2.5210756594751009603.11172870739032778909",
      "1.2.246.352.62.2.5405544414834140737.10435320682879197579",
      "1.2.246.352.62.2.5401383109444683335.14912119776149517712",
      "1.2.246.352.62.2.5349246692312153212.6937559147488128662",
      "1.2.246.352.62.2.4947098184234532387.7309228569600825767",
      "1.2.246.352.62.2.4648412184809110821.899346862499492009",
      "1.2.246.352.62.2.5201889237131290016.3251696867169258645",
      "1.2.246.352.62.2.5229480817028366757.4498713650385996467"

    )

    val July_Missing = Seq(
      "1.2.246.352.82.2.4696627465009346287.7764651567233259967",
      "1.2.246.352.82.2.5329077856566641327.165588288860182985500",
      "1.2.246.352.82.2.5011311838805473612.7500494674958596522",
      "1.2.246.352.82.2.5361723863855679754.166021144526660606820",
      "1.2.246.352.82.2.5463289547211611621.160351204619615917320",
      "1.2.246.352.82.2.5278667032135451751.111694269213501999600",
      "1.2.246.352.82.2.5196708497429941436.1904171721664415636",
      "1.2.246.352.82.2.4951168874005440125.150696683841031730200",
      "1.2.246.352.82.2.5450057983165722520.4206793130747644053",
      "1.2.246.352.82.2.5354013429153931319.8182766043660105618",
      "1.2.246.352.82.2.5332262016166518156.9714363484830040728",
      "1.2.246.352.82.2.4869825879356931624.8179552813496481196",
      "1.2.246.352.82.2.5020094436495491695.174304859341039013350",
      "1.2.246.352.82.2.5641944377716872647.4487972671611197332",
      "1.2.246.352.82.2.5362491525275838739.126899978255478747110",
      "1.2.246.352.82.2.4762026152282970535.7854353605996283789",
      "1.2.246.352.82.2.5049610885255001564.4139430415614867608",
      "1.2.246.352.82.2.4678274420363059356.118890168585111955740",
      "1.2.246.352.82.2.5151547185810714742.4872762087646020518",
      "1.2.246.352.82.2.4984251775700320563.6099252492162274179",
      "1.2.246.352.62.2.4621662116861067592.4358318185568287617",
      "1.2.246.352.82.2.5685850871439506860.104668113666949526080",
      "1.2.246.352.82.2.5085705511728010847.107764481073505447980",
      "1.2.246.352.82.2.4919828702553574295.121116525325480618860",
      "1.2.246.352.62.2.4818964515034600840.15606836645989092788",
      "1.2.246.352.62.2.5723117768221305248.15001014583810686615",
      "1.2.246.352.62.2.5083858667882438128.17979072360886147509",
      "1.2.246.352.62.2.5079214791382607895.14219903055528725911",
      "1.2.246.352.62.2.5161081842420901476.17195351266292526250",
      "1.2.246.352.82.2.4626702297708678971.172414685159194256670",
      "1.2.246.352.82.2.5410591585538414670.97899221015318230",
      "1.2.246.352.82.2.5411343647571945886.7680055459944828057",
      "1.2.246.352.62.2.5084908802780433895.6668435723973520060",
      "1.2.246.352.62.2.4823094785222953252.12246786449548780416",
      "1.2.246.352.62.2.5692222453687041079.6078527121665099148",
      "1.2.246.352.62.2.5474205045442706975.14174218829548284837",
      "1.2.246.352.62.2.5154378800784573751.220851191387227521",
      "1.2.246.352.62.2.5682586737434269430.1372902577584779192",
      "1.2.246.352.62.2.4758738348767006856.17353918851715803301",
      "1.2.246.352.62.2.5135719153069503774.11096751560282050214",
      "1.2.246.352.62.2.4940482890006938946.4634313725971098528",
      "1.2.246.352.62.2.4900602399840477717.13792456753541027730",
      "1.2.246.352.62.2.5327983640063025320.5217947459226388410",
      "1.2.246.352.62.2.5111491922445126836.9702751267751984552",
      "1.2.246.352.62.2.5618242596827916561.4963181429376523676",
      "1.2.246.352.62.2.4797683987044843839.1882145222275809205",
      "1.2.246.352.62.2.5119757180108700931.8602751571808623798",
      "1.2.246.352.62.2.4988207643257102596.4550316935761188753",
      "1.2.246.352.62.2.5744277355012974998.6440003064778736779",
      "1.2.246.352.62.2.5292113195247628507.18242540742052244364",
      "1.2.246.352.62.2.5184744018679138741.6119221378471946940",
      "1.2.246.352.218.5149589702497359493.1115218849668615301",
      "1.2.246.352.82.2.5731015508796766347.3762224970798980738",
      "1.2.246.352.82.2.5401825985204701268.2388105820587006618",
      "1.2.246.352.82.2.4946701764028087809.6807595975254028211",
      "1.2.246.352.82.2.4881015798979663417.8428095944000247216",
      "1.2.246.352.82.2.5407623269194137969.7604804047955638176",
      "1.2.246.352.82.2.4854550885772708081.122025153532126212200",
      "1.2.246.352.82.2.5348453312732998048.8735674428760429972",
      "1.2.246.352.82.2.5189125322771486742.131291995157597577440",
      "1.2.246.352.82.2.4822436399355833717.140491897084170481930",
      "1.2.246.352.82.2.5680313748596014683.1718483007484018060",
      "1.2.246.352.62.2.4832077579699468163.11786461486419434676",
      "1.2.246.352.62.2.5250173131300002190.4206422084200539525",
      "1.2.246.352.62.2.4907529464308022260.5092181023830847410",
      "1.2.246.352.62.2.5759987647173079571.11270202361479749796",
      "1.2.246.352.62.2.5423790742353090125.15061621839516196750",
      "1.2.246.352.82.2.5686375812489246492.103746700962571322110",
      "1.2.246.352.82.2.5487807530081990927.121267603575340192200",
      "1.2.246.352.82.2.5504391231850096979.5470228290036519092",
      "1.2.246.352.62.2.4627218795522075397.1496956045813148054",
      "1.2.246.352.62.2.4643066175668123531.13617758621748587958",
      "1.2.246.352.62.2.5625866713042037367.11535848510028541312",
      "1.2.246.352.62.2.4860385440600660905.18317401488258824067",
      "1.2.246.352.62.2.5539109035838903462.15833823418138249649",
      "1.2.246.352.62.2.4996055848417170003.8344102451420737449",
      "1.2.246.352.62.2.5379215343342086437.17340639226325352884",
      "1.2.246.352.62.2.5356670696289453660.9460389101249285545",
      "1.2.246.352.62.2.5486783663774587640.7056749507329783710",
      "1.2.246.352.62.2.4770685615062574880.1791426155610821769",
      "1.2.246.352.62.2.5022133977847766524.2172233109426712222",
      "1.2.246.352.62.2.5456939373445458698.14771262878235992224",
      "1.2.246.352.62.2.5550646353891256516.12456352226005193630",
      "1.2.246.352.62.2.5598318030386929713.3201160602406184607",
      "1.2.246.352.62.2.4899752525147809073.10141434261844624809",
      "1.2.246.352.62.2.5009830312461113492.16708341509714275486",
      "1.2.246.352.218.5349925202272631553.9799956763954333855",
      "1.2.246.352.218.4967243000294594561.6120722213596860079",
      "1.2.246.352.218.5337318364240266193.18422075853959379341",
      "1.2.246.352.218.5722614200276370269.3446581286485384122",
      "1.2.246.352.62.2.5127440260781761284.14643226979894095744",
      "1.2.246.352.218.5722162689568888024.15906915536965260466",
      "1.2.246.352.218.5659463224156544056.14907999664144566206",
      "1.2.246.352.62.2.5676339749216268934.13177874665493721751",
      "1.2.246.352.62.2.5603330835616722462.3202169688693386918",
      "1.2.246.352.62.2.4850543347930270007.13681744467102153394",
      "1.2.246.352.82.2.4775650120832297463.8271906653620501688",
      "1.2.246.352.82.2.5253340885302206645.126705108048160421570",
      "1.2.246.352.82.2.5114047541062336243.9531195870009492629",
      "1.2.246.352.62.2.5749051469043005434.13996206334912824767"
    )

    val working = Seq("1.2.246.352.62.2.5035239981428730453.17224928362942256548")

    /**
     * Get DICOM by SeriesInstanceUID.
     */
    def fetchSeries(seriesUid: String): Unit = {
      dicomReceiver.setSubDir(seriesUid)
      val id = buildIdentifier
      val id2 = addAttr(TagFromName.SeriesInstanceUID, seriesUid, id)
      val subDir = new File(mainDir, seriesUid)
      if (subDir.exists) try{edu.umro.util.Utility.deleteFileTree(subDir)} catch { case _ : Throwable => }

      dicomReceiver.setSubDir(subDir)
      println("Putting files into " + dicomReceiver.getSubDir.getAbsolutePath)
      val start = System.currentTimeMillis
      val success = dicomReceiver.cmove(id, thatPacs, thisPacs, SOPClass.PatientRootQueryRetrieveInformationModelMove)
      val elapsed = System.currentTimeMillis - start
      val status = if (success.isDefined) "Failed: " + success.get else "Success"
      println("elapsed ms: " + elapsed + "    Status: " + status)
    }

    /**
     * Get DICOM by SOPInstanceUID.
     */
    def fetchInstance(sopUid: String): Unit = {
      dicomReceiver.setSubDir(sopUid)
      val id = buildIdentifier
      val id2 = addAttr(TagFromName.SOPInstanceUID, sopUid, id)
      val subDir = new File(mainDir, sopUid)
      if (subDir.exists) edu.umro.util.Utility.deleteFileTree(subDir)

      dicomReceiver.setSubDir(subDir)
      println("Putting files into " + dicomReceiver.getSubDir.getAbsolutePath)
      val start = System.currentTimeMillis
      val success = dicomReceiver.cmove(id, thatPacs, thisPacs, SOPClass.PatientRootQueryRetrieveInformationModelMove)
      val elapsed = System.currentTimeMillis - start
      val status = if (success.isDefined) "Failed: " + success.get else "Success"
      println("elapsed ms: " + elapsed + "    Status: " + status)
    }

    val start = System.currentTimeMillis
    //seriesUidSeq.map(fetchSeries)
    //sopRtplanList.map(fetchInstance)
    //seriesTX2_RTIMAGE.map(fetchSeries)
    //regSeriesList.map(fetchSeries)
    //July_Missing.foreach(fetchSeries)
    working.foreach(fetchSeries)

    println("Done.  Elapsed ms: " + (System.currentTimeMillis - start))
    System.exit(0)
  }

}
